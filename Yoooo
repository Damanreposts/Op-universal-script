--// UI LIB
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.ResetOnSpawn = false
ScreenGui.Name = "GeminiAI_UI"

-- Centered Frame
local Frame = Instance.new("Frame", ScreenGui)
Frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
Frame.Size = UDim2.new(0, 260, 0, 260)
Frame.Position = UDim2.new(0.5, -130, 0.5, -130)
Frame.Active = true
Frame.Draggable = false  -- we use custom dragging

-- Round corners
local UI = Instance.new("UICorner", Frame)
UI.CornerRadius = UDim.new(0, 10)

-- Title
local Title = Instance.new("TextLabel", Frame)
Title.Size = UDim2.new(1,0,0,35)
Title.BackgroundColor3 = Color3.fromRGB(35,35,35)
Title.Text = "Gemini AI Control Panel"
Title.TextColor3 = Color3.fromRGB(255,255,255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
local UI2 = Instance.new("UICorner", Title)
UI2.CornerRadius = UDim.new(0, 10)

-- KEY BOX
local KeyBox = Instance.new("TextBox", Frame)
KeyBox.PlaceholderText = "Enter Gemini Key"
KeyBox.Size = UDim2.new(1, -20, 0, 30)
KeyBox.Position = UDim2.new(0, 10, 0, 50)
KeyBox.BackgroundColor3 = Color3.fromRGB(45,45,45)
KeyBox.TextColor3 = Color3.new(1,1,1)
KeyBox.Font = Enum.Font.Gotham
KeyBox.TextSize = 14
Instance.new("UICorner", KeyBox)

-- AI Toggle
local ToggleAI = Instance.new("TextButton", Frame)
ToggleAI.Size = UDim2.new(1, -20, 0, 35)
ToggleAI.Position = UDim2.new(0, 10, 0, 95)
ToggleAI.BackgroundColor3 = Color3.fromRGB(50,50,50)
ToggleAI.Text = "AI: OFF"
ToggleAI.TextColor3 = Color3.new(1,1,1)
ToggleAI.Font = Enum.Font.GothamBold
ToggleAI.TextSize = 16
Instance.new("UICorner", ToggleAI)

-- Public Toggle
local TogglePub = Instance.new("TextButton", Frame)
TogglePub.Size = UDim2.new(1, -20, 0, 35)
TogglePub.Position = UDim2.new(0, 10, 0, 140)
TogglePub.BackgroundColor3 = Color3.fromRGB(50,50,50)
TogglePub.Text = "Public AI: OFF"
TogglePub.TextColor3 = Color3.new(1,1,1)
TogglePub.Font = Enum.Font.GothamBold
TogglePub.TextSize = 16
Instance.new("UICorner", TogglePub)

-- Status Label
local Status = Instance.new("TextLabel", Frame)
Status.Size = UDim2.new(1, -20, 0, 30)
Status.Position = UDim2.new(0, 10, 0, 185)
Status.BackgroundTransparency = 1
Status.TextColor3 = Color3.fromRGB(255,255,255)
Status.Font = Enum.Font.Gotham
Status.TextSize = 14
Status.Text = "Waiting for key..."

-- VARIABLES
local AI_ENABLED = false
local PUBLIC_ENABLED = false
local API_KEY = nil

-- Toggles
ToggleAI.MouseButton1Click:Connect(function()
    AI_ENABLED = not AI_ENABLED
    ToggleAI.Text = AI_ENABLED and "AI: ON" or "AI: OFF"
end)

TogglePub.MouseButton1Click:Connect(function()
    PUBLIC_ENABLED = not PUBLIC_ENABLED
    TogglePub.Text = PUBLIC_ENABLED and "Public AI: ON" or "Public AI: OFF"
end)

-- When user presses enter on keybox
KeyBox.FocusLost:Connect(function(enter)
    if enter then
        API_KEY = KeyBox.Text
        if API_KEY ~= "" then
            Status.Text = "Key saved. AI ready."
        end
    end
end)

-- CHAT LISTENER
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

LocalPlayer.Chatted:Connect(function(msg)
    if not AI_ENABLED then return end
    if not msg:lower():sub(1,3) == "#ai" then return end

    -- If public mode OFF and not you
    if (not PUBLIC_ENABLED) and LocalPlayer ~= Players.LocalPlayer then
        return
    end

    if not API_KEY then
        Status.Text = "ERROR: Enter API key!"
        return
    end

    local q = msg:sub(5)

    -- Gemini API call
    local response
    pcall(function()
        response = game:HttpPost(
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key="..API_KEY,
            '{"contents":[{"parts":[{"text":"'..q..'"}]}]}',
            Enum.HttpContentType.ApplicationJson
        )
    end)

    local answer = response or "AI ERROR"

    game:GetService("ReplicatedStorage").DefaultChatSystemChatEvents.SayMessageRequest:FireServer(
        answer, "All"
    )
end)

-- MOBILE DRAGGING (smooth + Delta safe)
local UIS = game:GetService("UserInputService")
local dragging = false
local dragStart
local startPos

Title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = Frame.Position
    end
end)

Title.InputEnded:Connect(function(input)
    dragging = false
end)

UIS.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseMovement) then
        local delta = input.Position - dragStart
        Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
