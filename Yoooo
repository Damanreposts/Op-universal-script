-- Services
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- Local Player and Character references
local LocalPlayer = Players.LocalPlayer
local Character
local Humanoid
local HumanoidRootPart
local Camera = game.Workspace.CurrentCamera

-- Function to safely get character parts, handling respawns
local function getCharacterParts()
    Character = LocalPlayer.Character
    if not Character or not Character:IsDescendantOf(game.Workspace) then
        Character = LocalPlayer.CharacterAdded:Wait()
    end
    Humanoid = Character:WaitForChild("Humanoid")
    HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
end

-- Initial call to get character parts
getCharacterParts()

-- Store original walkspeed for potential restoration or reference
local OriginalWalkSpeed = Humanoid.WalkSpeed

-- Handle character respawns to ensure features continue to work
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    Humanoid = newChar:WaitForChild("Humanoid")
    HumanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
    
    -- If fly was active, re-enable it on the new character
    if Flying then
        Humanoid.PlatformStand = true
        Humanoid.AutoRotate = false
    end
    
    -- Apply the current walkspeed to the new character
    Humanoid.WalkSpeed = CurrentWalkSpeed
end)

-- Load Orion Library
local OrionLib = loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/Orion/main/source"))()

-- Create the main GUI window
local Window = OrionLib:MakeWindow({
    Name = "Player Utilities",
    HidePremium = false, -- Set to true to remove the "Premium" tag
    SaveConfig = true,  -- If true, GUI settings will be saved
    ConfigFolder = "PlayerUtilities" -- Folder name for saved configurations
})

-- Create a tab for movement features
local MainTab = Window:MakeTab({
    Name = "Movement"
})

-- Fly Feature variables
local Flying = false
local FlyConnection = nil
local FlySpeed = 50 -- Fly speed in studs per second

-- Add the "Toggle Fly" button
MainTab:AddButton({
    Name = "Toggle Fly",
    Callback = function()
        Flying = not Flying -- Toggle fly state
        if Flying then
            getCharacterParts() -- Ensure we have the latest character parts
            if Humanoid and HumanoidRootPart then
                Humanoid.PlatformStand = true -- Disable physics-based movement
                Humanoid.AutoRotate = false   -- Prevent character from rotating automatically
                
                -- Connect to Heartbeat for smooth, frame-rate independent movement
                FlyConnection = RunService.Heartbeat:Connect(function(dt)
                    -- Check if character or essential parts are still valid
                    if not Character or not Humanoid or Humanoid.Health <= 0 or not HumanoidRootPart then
                        -- Character died or parts are gone, stop flying
                        Flying = false
                        if FlyConnection then FlyConnection:Disconnect() FlyConnection = nil end
                        getCharacterParts() -- Attempt to reset parts for next time
                        if Humanoid then Humanoid.PlatformStand = false Humanoid.AutoRotate = true end
                        return
                    end

                    local moveVector = Vector3.new()
                    local camCFrame = Camera.CFrame

                    -- Process movement input (W, A, S, D, Space, LeftShift)
                    if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveVector += camCFrame.LookVector end
                    if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveVector -= camCFrame.LookVector end
                    if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveVector -= camCFrame.RightVector end
                    if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveVector += camCFrame.RightVector end
                    if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveVector += Vector3.new(0, 1, 0) end -- Move Up
                    if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then moveVector -= Vector3.new(0, 1, 0) end -- Move Down

                    -- Apply movement if there's input
                    if moveVector.Magnitude > 0 then
                        moveVector = moveVector.Unit * FlySpeed * dt -- Scale movement by FlySpeed (studs/sec) and delta time
                        HumanoidRootPart.CFrame = HumanoidRootPart.CFrame + moveVector
                    end
                end)
            else
                warn("Fly: Humanoid or HumanoidRootPart not found. Cannot enable fly.")
                Flying = false -- Reset if parts are missing
            end
        else
            -- Disable fly: Disconnect the Heartbeat connection
            if FlyConnection then
                FlyConnection:Disconnect()
                FlyConnection = nil
            end
            getCharacterParts() -- Ensure we have the latest character parts
            if Humanoid then
                Humanoid.PlatformStand = false -- Re-enable physics-based movement
                Humanoid.AutoRotate = true      -- Re-enable automatic character rotation
            end
        end
    end
})

-- Walkspeed Feature variables
local DefaultWalkSpeed = 16
local CurrentWalkSpeed = DefaultWalkSpeed -- Initialize with default walkspeed

-- Add the "Walkspeed" slider
MainTab:AddSlider({
    Name = "Walkspeed",
    Min = 16,    -- Minimum walkspeed
    Max = 100,   -- Maximum walkspeed
    Default = DefaultWalkSpeed, -- Default value when GUI loads
    Callback = function(Value)
        CurrentWalkSpeed = Value -- Update current walkspeed variable
        getCharacterParts()      -- Ensure we have the latest character parts
        if Humanoid then
            Humanoid.WalkSpeed = Value -- Apply the new walkspeed to the humanoid
        end
    end
})

-- Apply initial walkspeed when the script loads
getCharacterParts()
if Humanoid then
    Humanoid.WalkSpeed = DefaultWalkSpeed
end

-- Display a notification when the script has finished loading
OrionLib:MakeNotification({
    Name = "Player Utilities Loaded!",
    Content = "GUI has been loaded successfully.",
    Image = "rbxassetid://4483345998", -- Generic Roblox icon asset ID
    Time = 5 -- Notification display time in seconds
})
